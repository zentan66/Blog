

#### 流程概括

webpack运行流程是一个串行的过程，从启动到结束依次执行以下流程：

1. 初始化参数：从配置文件和 Shell 语句中读取与合并参数，得出最终的参数；
2. 开始编译：用上一步得到的参数初始化 Compiler 对象，加载所有配置的插件，执行对象的 run 方法开始执行编译；
3. 确定入口：根据配置中的 entry 找出所有的入口文件；
4. 编译模块：从入口文件出发，调用所有配置的 Loader 对模块进行翻译，再找出该模块依赖的模块，再递归本步骤直到所有入口依赖的文件都经过了本步骤的处理；
5. 完成模块编译：在经过第4步使用 Loader 翻译完所有模块后，得到了每个模块被翻译后的最终内容以及它们之间的依赖关系；
6. 输出资源：根据入口和模块之间的依赖关系，组装成一个个包含多个模块的 Chunk，再把每个 Chunk 转换成一个单独的文件加入到输出列表，这步是可以修改输出内容的最后机会；
7. 输出完成：在确定好输出内容后，根据配置确定输出的路径和文件名，把文件内容写入到文件系统。

Webpack会在特定的时间点广播出特定的事件，插件在监听到感兴趣的事件后会执行特定的逻辑，并且插件可以调用webpack提供的API改变Webpack运行结果

#### 流程细节

##### 初始化阶段

| 事件名            | 解释                                                         |
| ----------------- | ------------------------------------------------------------ |
| 初始化参数        | 从配置文件和Shell语句中读取合并参数，得出最终参数，这个过程中会执行配置文件中的插件实例化语句`new Plugin` |
| 实例化`Compiler`  | 用上一步得到的参数初始化`Compiler`实例，该实例负责文件监听与启动编译，全局仅有一个`Compiler`实例 |
| 加载插件          | 依次调用插件的`apply`方法，让插件可以监听到后续的所有事件节点，同时给插件传入`compiler`实例的引用 |
| `environment`     | 开始应用Nodejs风格的文件系统到`compiler`对象                 |
| `entry-option`    | 读取配置的`entry`，为每个`entry`实例化一个对应的`EntryPlugin`，为后面的`Entry`递归解析工作做准备 |
| `after-plugin`    | 调用完所有内置的和配置的插件的`apply`方法                    |
| `after-resolvers` | 根据配置初始化玩`resolver`，`resolver`负责在文件系统中寻找指定路径的文件 |

##### 编译阶段

| 事件            | 解释                                                         |
| --------------- | ------------------------------------------------------------ |
| `run`           | 启动一次新的编译                                             |
| `watch-run`     | 和`run`类似，区别在于这是在监听模式下启动的编译              |
| `compile`       | 告诉插件一次新的编译将要启动，同时给插件带上`compiler`对象   |
| `compilation`   | 当`Webpack`以开发模式运行时，每当检测到文件变化，一次新的`Compilation`将被创建，一个`Compilation`对象包含了当前的模块资源、编译生成资源、变化的文件等。`Compilation`对象也提供了很多事件回调供插件做拓展 |
| `make`          | 一个新的`Compilation`创建完毕，即将从`Entry`开始读取文件，根据文件类型和配置的`Loader`对文件进行编译，编译完成找出该文件依赖的文件，递归的编译和解析 |
| `after-compile` | 一次`Compilation`执行完成                                    |
| `invalid`       | 当遇到文件不存在、文件编译错误等异常时会触发该事件，该事件不会导致`Webpack`退出 |

在`compilation`阶段有包含很多小事件：

| 事件名                 | 解释                                                         |
| ---------------------- | ------------------------------------------------------------ |
| `build-module`         | 使用对应的Loader转换一个模块                                 |
| `normal-module-loader` | 在用Loader对一个模块转换后，使用`acorn`解析转换后的内容，输出对应的抽象语法树，以方便Webpack后面对代码的分析 |
| `program`              | 从配置的入口模块开始，分析其AST，当遇到require等导入其他模块语句时，便将其加入到依赖的模块列表，同时对新找出的依赖模块递归分析，最终搞清所有模块的依赖关系 |
| `seal`                 | 所有模块及其依赖的模块都通过Loader转换完成后，根据依赖关系生成Chunk |

#### 输出阶段

| 事件名        | 解释                                                         |
| ------------- | ------------------------------------------------------------ |
| `should-emit` | 所有需要输出的文件已经生成好，询问插件那些文件需要输出，哪些不需要 |
| `emit`        | 确定好输出哪些文件后，执行文件输出，可以在这里获取和修改输出内容 |
| `after-emit`  | 文件输出完毕                                                 |
| `done`        | 成功完成一次编译和输出流程                                   |
| `failed`      | 如果在编译和输出流程中遇到异常导致Webpack退出时，就会直接跳到本步骤，插件可以在本事件中获取到具体的错误原因 |

